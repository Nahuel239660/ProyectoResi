#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

BRANCH_NAME=$(git symbolic-ref --short HEAD)
TICKET_ID=$(echo "$BRANCH_NAME" | grep -oE "sc-[0-9]+")
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# No validar en main o develop
if [ "$BRANCH_NAME" = "main" ] || [ "$BRANCH_NAME" = "develop" ]; then
  echo "üîì Commit libre en rama $BRANCH_NAME"
  exit 0
fi

# Tipos permitidos
VALID_TYPES="feat|fix|chore|ref"

# Validar formato tipo: [sc-123]
echo "$COMMIT_MSG" | grep -E "^($VALID_TYPES): \[$TICKET_ID\]" > /dev/null

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Commit inv√°lido en rama '$BRANCH_NAME'"
  echo "Debe comenzar con uno de estos tipos: feat:, fix:, chore:, ref:"
  echo "Y contener el ID de la rama entre corchetes: [$TICKET_ID]"
  echo ""
  echo "Ejemplo: feat: [$TICKET_ID] agrega validaci√≥n de email"
  exit 1
fi

echo "‚úÖ Commit v√°lido con tipo y ticket [$TICKET_ID]"
exit 0
